<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="lib/dependencies/scripts/jquery.min.js"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="lib/LAN/ip_discovery.js"></script>
    <script type="text/javascript" src="lib/StringUtils.js"></script>
    <script type="text/javascript" src="lib/Tokenizer.js"></script>
    <script type="text/javascript" src="lib/P3Com/EventDispatcher.js"></script>
    <script type="text/javascript" src="lib/P3Com/Command.js"></script>
    <script type="text/javascript" src="lib/P3Com/CommandType.js"></script>
    <script type="text/javascript" src="lib/P3Com/Host.js"></script>
    <script type="text/javascript" src="lib/P3Com/P3Com.js"></script>
    <script type="text/javascript" src="lib/P3Com/P3ComEventType.js"></script>
    <script type="text/javascript" src="lib/P3Com/P3ComManager.js"></script>
    <script type="text/javascript" src="lib/P3Com/FiscalPrinter/FiscalPrinterEventType.js"></script>
    <script type="text/javascript" src="lib/P3Com/FiscalPrinter/FiscalPrinter.js"></script>
    <script type="text/javascript" src="lib/P3Com/FiscalPrinter/FiscalPrinterConfig.js"></script>
    <script type="text/javascript" src="lib/P3Com/FiscalPrinter/FiscalPrinterProperties.js"></script>
    <script type="text/javascript" src="lib/P3Com/FiscalPrinter/FiscalPrinterType.js"></script>
    <script type="text/javascript" src="lib/P3Com/FiscalPrinter/PromoProperties.js"></script>
    <script type="text/javascript" src="lib/P3Com/FiscalPrinter/Invoice.js"></script>
    <script type="text/javascript" src="lib/P3Com/FiscalPrinter/InvoiceItem.js"></script>
    <script type="text/javascript" src="lib/ArrayUtils.js"></script>
    <script type="text/javascript" src="lib/BinUtils.js"></script>
    <script type="text/javascript" src="lib/ObjectUtils.js"></script>
    <script type="text/javascript" src="lib/StringUtils.js"></script>
    <script type="text/javascript" src="lib/DecoratorUtils.js"></script>
    <script type="text/javascript" src="lib/binding/BindingUtils.js"></script>
    <script type="text/javascript" src="components/base/Component.js"></script>
    <script type="text/javascript" src="components/base/Parent.js"></script>
    <script type="text/javascript" src="components/base/NavParent.js"></script>
    <script type="text/javascript" src="components/base/Selectable.js"></script>
    <script type="text/javascript" src="components/Loader.js"></script>
    <script type="text/javascript" src="components/Modal/Modal.js"></script>
    <script type="text/javascript" src="components/Modal/ModalSize.js"></script>
    <script type="text/javascript" src="components/TextInput.js"></script>
    <script type="text/javascript" src="components/CheckBox.js"></script>
    <script type="text/javascript" src="components/Select.js"></script>
    <script type="text/javascript" src="components/Button.js"></script>
    <script type="text/javascript" src="components/Form/Form.js"></script>
    <script type="text/javascript" src="components/Form/FormField.js"></script>
    <script type="text/javascript" src="components/Form/FormEventType.js"></script>
    <script type="text/javascript" src="lib/dependencies/scripts/jquery.inputmask.bundle.min.js"></script>
</head>
<body>
<div id="root"></div>
<div id="scan" width="400px" height="400px"></div>
</body>
<script>
    var P3ComInstance = new P3Com("ws://127.0.0.1:4669/");
    var printer = new FiscalPrinter(P3ComInstance);

    printer.on(FiscalPrinterEventType.CONNECTION_CLOSE, function (e, data) {
        alert("Connection terminated!");
    });

    printer.on(FiscalPrinterEventType.CONNECTION_ERROR, function (e, data) {
        alert("Check if P3Com is running and fiscal printer is connected!");
    });

    printer.on(FiscalPrinterEventType.FISCAL_RECEIPT_RECEIVED, function (e, data) {
        alert("Fiscal receipt data were proccessed successfully!");
    });

    printer.on(FiscalPrinterEventType.FISCAL_RECEIPT_REJECTED, function (e, data) {
        alert("Fiscal receipt data error!");
    });

    printer.on(FiscalPrinterEventType.FISCAL_RECEIPT_PRINTED, function (e, data) {
        alert("Fiscal receipt printed successfully!");
    });

    printer.on(FiscalPrinterEventType.FISCAL_RECEIPT_PRINT_FAILED, function (e, data) {
        alert("Fiscal receipt print failed!");
    });

    printer.on(FiscalPrinterEventType.CONFIGURATION_RECEIVED, function (e, data) {
        alert("Fiscal configuration data were proccessed successfully!");
    });

    printer.on(FiscalPrinterEventType.CONFIGURATION_REJECTED, function (e, data) {
        alert("Fiscal configuration data error!");
    });

    printer.on(FiscalPrinterEventType.CONFIGURATION_WRITTEN, function (e, data) {
        alert("Fiscal configuration file was written successfully!");
    });

    printer.on(FiscalPrinterEventType.CONFIGURATION_WRITE_FAILED, function (e, data) {
        alert("Fiscal configuration file was not written!");
    });

    var printFiscalReceipt = function () {
        var items = JSON.parse('[{"id_salesorderheader":"65246","salesorderbody_id":"133424","id_item":"3","item_code":"400KA100","item_name":"Kapsule - Ama Intenso - kuti 10","item_description":"","id_unit":"1","unit_name":"Cope","quantity":"150.00","price":"55.00","subtotal":"8250.00","deleted":"0","discount_percent":"0","item_id":"3","item_resume":"400KA100-Kapsule - Ama Intenso - kuti 10","subTotal":8250,"subTotalDiscounted":8250},{"id_salesorderheader":"65246","salesorderbody_id":"133425","id_item":"4","item_code":"400KA103","item_name":"Kapsule - Ama Premium - kuti 10","item_description":"","id_unit":"1","unit_name":"Cope","quantity":"30.00","price":"55.00","subtotal":"1650.00","deleted":"0","discount_percent":"0","item_id":"4","item_resume":"400KA103-Kapsule - Ama Premium - kuti 10","subTotal":1650,"subTotalDiscounted":1650},{"id_salesorderheader":"65246","salesorderbody_id":"133426","id_item":"26","item_code":"400KA106","item_name":"Kapsule - Ama Deccafienato - kuti 10","item_description":"","id_unit":"1","unit_name":"Cope","quantity":"80.00","price":"55.00","subtotal":"4400.00","deleted":"0","discount_percent":"0","item_id":"26","item_resume":"400KA106-Kapsule - Ama Deccafienato - kuti 10","subTotal":4400,"subTotalDiscounted":4400},{"id_salesorderheader":"65246","salesorderbody_id":"133427","id_item":"1347","item_code":"400KA109","item_name":"Kapsule - Ama Soprano- kuti 10","item_description":"","id_unit":"1","unit_name":"Cope","quantity":"20.00","price":"55.00","subtotal":"1100.00","deleted":"0","discount_percent":"0","item_id":"1347","item_resume":"400KA109-Kapsule - Ama Soprano- kuti 10","subTotal":1100,"subTotalDiscounted":1100}]');
        var body = [];

        for (var i = 0; i < items.length; i++) {
            body[i] = new InvoiceItem();
            body[i].item_name = items[i].item_name;
            body[i].quantity = items[i].quantity;
            body[i].price = items[i].price;
            body[i].vat = 1;//items[i];
            body[i].item_vat = 1;//items[i];
            body[i].fiscal_item_code = items[i].item_code;
            body[i].discount_percent = items[i].discount_percent;
            body[i].vat_category = 1;//items[i];
            body[i].subtotal_with_vat = items[i].subtotal;
            body[i].unit = items[i].unit_name;
        }

        var header = new Invoice();
        header.document_number = '000001';
        header.serial_number = '000001';
        header.id_paymethod = '2';
        header.invoice_type = '1';
        header.invoiceBody = body;

        printer.PrintalFiscalReceipt(header);
    };

    var openModal = function () {
        if (configModal !== null || configModal !== undefined) {
            configModal.show();
        }
    };

    var fillConfigModal = function () {
        configModal.$body.append(fiscalFilePath.render());
        configModal.$body.append(fiscalBackupPath.render());
        configModal.$body.append(keepBackup.render());
        configModal.$body.append(fiscalExePath.render());
        configModal.$body.append(fiscalPrinterType.render());
        configModal.$body.append(priceCoeficient.render());
        configModal.$body.append(invFooterMessage.render());
        configModal.$body.append(invCelNumber.render());
        configModal.$footer.append(saveConfig.render());
    };

    var saveConfiguration = function () {
        var data = new FiscalPrinterConfig();

        var FiscalPrinterProperties = {
            type: fiscalPrinterType.value == 1 ? FiscalPrinterType.AEDENG :
                ( fiscalPrinterType.value == 2 ? FiscalPrinterType.AEDITA : FiscalPrinterType.NONE ),
            filepath: fiscalFilePath.value,
            backupFilePath: fiscalBackupPath.value,
            keepBackup: keepBackup.checked ? "true" : "false",
            fileName: fileName.value,
            priceCoefficient: priceCoeficient.value,
            fiscalExePath: fiscalExePath.value
        };

        var PromoProperties = {
            invoiceFooterMessage: invFooterMessage.value,
            invoiceCelNumber: invCelNumber.value
        };

        data.FiscalPrinter = extend(false, false, data.FiscalPrinter, FiscalPrinterProperties);
        data.Promo = extend(false, false, data.Promo, PromoProperties);

        for (var i = 0; i < 2; i++) {
            obj = i ? data.Promo : data.Fiscalprinter;
            for (var key in obj) {
                if (obj.hasOwnProperty(key)) {
                    if (obj[key] === undefined) {
                        delete obj[key];
                    }
                }
            }
        }

        printer.WriteConfiguration(data);
    };

    var printFiscal = new Button({
        id: "print-fiscal",
        type: "button",
        label: "Print Fiscal Receipt",
        style: "",
        class: "btn btn-success",
        click: printFiscalReceipt
    });

    var writeConfig = new Button({
        id: "write-config",
        type: "button",
        label: "Write Configuration",
        style: "",
        class: "btn btn-success",
        click: openModal
    });

    var saveConfig = new Button({
        id: "save-config",
        type: "button",
        label: "Save Configuration",
        style: "",
        class: "btn btn-success",
        click: saveConfiguration
    });

    var configModal = new Modal({
        id: 'config-modal',
        size: 'modal-lg',
        title: 'Configure Fiscal Printer'
    });

    var fiscalFilePath = new TextInput({
        class: 'form-control',
        id: 'fiscal-filepath',
        required: true,
        mask: '',
        value: 'C:\\com\\'
    });

    var fiscalBackupPath = new TextInput({
        class: 'form-control',
        id: 'fiscal-backuppath',
        required: true,
        mask: '',
        value: 'C:\\com\\backup\\'
    });

    var keepBackup = new CheckBox({
        id: "keep-backup",
        label: "Ruaj BackUp",
        value: "1",
        enabled: true,
        checked: false
    });

    var fileName = new TextInput({
        class: 'form-control',
        id: 'fiscal-filename',
        required: true,
        mask: '',
        value: 'comt.txt'
    });

    var fiscalExePath = new TextInput({
        class: 'form-control',
        id: 'fiscal-exepath',
        required: true,
        mask: '',
        value: 'C:\\'
    });

    var fiscalPrinterType = new Select({
        id: 'fiscal-printer-type',
        dataProvider: [{"value": "1", "text": "English"}, {"value": "2", "text": "Italian"}],
        textField: "text",
        valueField: "value",
        value: "1",
    });

    var priceCoeficient = new TextInput({
        class: 'form-control',
        id: 'price-coeficient',
        required: true,
        mask: '',
        value: '100'
    });

    var invFooterMessage = new TextInput({
        class: 'form-control',
        id: 'footer-message',
        required: true,
        mask: '',
        value: 'Printuar nga Kreatx xS'
    });

    var invCelNumber = new TextInput({
        class: 'form-control',
        id: 'cel-number',
        required: true,
        mask: '',
        value: '+355 69 696 9090'
    });

    var alreadyCreated = false;

    configModal.on('creationComplete', function (e) {
        e.stopImmediatePropagation();
        e.stopPropagation();

        if (!alreadyCreated)
            fillConfigModal();

        alreadyCreated = true;
    });

    $("#root").append(printFiscal.render());
    $("#root").append(writeConfig.render());
    $("#root").append(configModal.render());


</script>
</html>