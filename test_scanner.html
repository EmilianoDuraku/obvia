<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="lib/P3Com/EventDispatcher.js"></script>
        <script type="text/javascript" src="lib/P3Com/FiscalPrinter/FiscalPrinterEventType.js"></script>
        <script type="text/javascript" src="lib/LAN/ip_discovery.js"></script>
        <script type="text/javascript" src="lib/StringUtils.js"></script>
        <script type="text/javascript" src="lib/P3Com/Command.js"></script>
        <script type="text/javascript" src="lib/P3Com/CommandType.js"></script>
        <script type="text/javascript" src="lib/P3Com/Host.js"></script>
        <script type="text/javascript" src="lib/P3Com/P3Com.js"></script>
        <script type="text/javascript" src="lib/P3Com/P3ComEventType.js"></script>
        <script type="text/javascript" src="lib/P3Com/P3ComManager.js"></script>
        <script type="text/javascript" src="lib/P3Com/FiscalPrinter/FiscalPrinter.js"></script>
        <script type="text/javascript" src="lib/P3Com/FiscalPrinter/Invoice.js"></script>
        <script type="text/javascript" src="lib/P3Com/FiscalPrinter/InvoiceItem.js"></script>
        <script type="text/javascript" src="lib/P3Com/Scanner/Scanner.js"></script>
        <script type="text/javascript" src="lib/P3Com/Scanner/ScanProperties.js"></script>
        <script type="text/javascript" src="lib/P3Com/Scanner/FileExtension.js"></script>
        <script type="text/javascript" src="lib/P3Com/Scanner/PaperType.js"></script>
        <script type="text/javascript" src="lib/P3Com/Scanner/ScannerEventType.js"></script>
        <script type="text/javascript" src="lib/ArrayUtils.js"></script>
        <script type="text/javascript" src="lib/BinUtils.js"></script>
        <script type="text/javascript" src="lib/ObjectUtils.js"></script>
        <script type="text/javascript" src="lib/StringUtils.js"></script>
        <script type="text/javascript" src="lib/DecoratorUtils.js"></script>
        <script type="text/javascript" src="lib/rivets.bundled.min.js"></script>
        <script type="text/javascript" src="lib/KxGenerator.js"></script>
        <script type="text/javascript" src="components/Loader.js"></script>
        <script type="text/javascript" src="components/Repeater.js"></script>
        <script type="text/javascript" src="components/RadioButton.js"></script>
        <script type="text/javascript" src="components/RadioGroup.js"></script>
        <script type="text/javascript" src="components/Modal.js"></script>
        <script type="text/javascript" src="components/List.js"></script>
        <script type="text/javascript" src="components/Button.js"></script>
        <script type="text/javascript" src="components/Form/Form.js"></script>
        <script type="text/javascript" src="components/Form/FormEventType.js"></script>
        
        <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    </head>
    <body>
        <div id="root"></div>
        <div id="scan" width="400px" height="400px"></div>
    </body>
    <script>
		var P3ComInstance = new P3Com("ws://192.168.1.62:4669/");
        var scan = new Scanner(P3ComInstance, "scan");
        
        var myForm = new Form({
            id: "form",
            type: "form",
            style: "",
            class: "",
            action: "test_scanner.php"
        });
        
        var i = 0;
        myForm.on(FormEventType.POST_PROGRESS, function(e, data) {
            console.log(e);
            console.log("======")
            console.log(data);
            console.log("-end-" + ++i)
        });

        var myRadioGroup = null;
		scan.on(ScannerEventType.SCANNER_LIST_LOADED, function(e, scannersList){
			if(!myRadioGroup)
			{
				myRadioGroup = new RadioGroup({
					id: 'radiogroup',
					colspan: '6',
					label: 'Radiogroup',
					fieldName: 'radioInput',
					blockProcessAttr: false,
					required: false,
					dataProvider: scannersList,
					valueField: 'deviceId',
					labelField: 'deviceName',
					classField: "buttonClass",
					defaultClass: 'btn btn-xs btn-default',
					selectedClass: 'btn btn-xs btn-success',
					enabledField: "enabled",
					value: [],
					onchange : function(e){
                        //console.log(myRadioGroup.value[0].deviceId);
                        scan.DeviceId = myRadioGroup.value[0].deviceId;
                        
                        //e.preventDefault();
					} 
				});
                myModal.$body.append(myRadioGroup.render());
                myModal.$body.append(confirmScanner.render());
				myModal.show();
			}
        });
        
        scan.on(ScannerEventType.DOCUMENT_SCANNED, function(e, base64string, contentType){
            console.log("Dokumenti u skanua. " + e);
            saveScan.enable();

            var blob = BinUtils.b64toBlob(base64string, contentType);
            myForm.addFileUploadField("scannedDocument", blob);   
            myForm.post();          
        });
			
        function loadScanners() 
		{
			scan.LoadScanners();
        }

        var scanItem = new ScanProperties();
        scanItem.deviceId = '';
        function scanDocument() 
        {   
            if (scan.DeviceId) {
                scanItem.filepath = "c:\\com\\";
                scanItem.name = "name";
                scanItem.extension = FileExtension.PDF;
                //scanItem.deviceId = "{6BDD1FC6-810F-11D0-BEC7-08002BE2092F}\\0000";
                scanItem.isAdf = true;
                
                paperSize = PaperType.toPixels(PaperType.A4, 140);
                scanItem.WIA_HORIZONTAL_SCAN_SIZE_PIXELS = paperSize.width;
                scanItem.WIA_VERTICAL_SCAN_SIZE_PIXELS = paperSize.height;
                console.log(scanItem);

                scan.Scan(scanItem);
            }
            else {
                whenDefined(scan, "DeviceId", scanDocument);
                loadScanners();
            }
        }

        function saveScannedItem () {
            scan.SaveScan();
        }

        var myModal = new Modal({
            id: 'autocomplete-modal-' + this.domID,
            size: 'modal-lg',
            title: 'Zgjidh Skaner',
        });
		
        var myButton = new Button({
            id: 'button',
            type: "button",
            value: "Load Scanners",
            style: '',
            class: "btn btn-success",
            onclick : loadScanners
        });
        $('#root').append(myButton.render());

        var confirmScanner = new Button({
            id: 'button',
            type: "button",
            value: "Scan Document",
            style: '',
            class: "btn btn-success",
            onclick : scanDocument
        });
        $('#root').append(confirmScanner.render());

        var saveScan = new Button({
            id: 'button',
            type: "button",
            value: "Save Scan",
            style: '',
            class: "btn btn-success",
            //enabled: false,
            onclick : saveScannedItem            
        });
        saveScan.disable();
        $('#root').append(saveScan.render());

        myModal.on('creationComplete', function (e) {
            //trigger autocomplete complete
            e.stopPropagation();
        })

        $('#root').append(myModal.render());
       
    </script>    
</html>